<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Management System - Cloud Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid #2a3f5f;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, #00d4ff 0%, #7e5fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #16a34a;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab {
            padding: 15px 25px;
            background: #1e293b;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            flex: 1;
            min-width: 140px;
            transition: all 0.3s;
        }
        .tab.active { background: linear-gradient(135deg, #00d4ff 0%, #7e5fff 100%); }
        .tab:hover { transform: translateY(-2px); }
        .content {
            background: #1e293b;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #2a3f5f;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            background: #0f172a;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #334155;
        }
        video, .preview-img { width: 100%; display: block; }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #0891b2 100%); }
        .btn-secondary { background: #334155; }
        .btn-danger { background: #dc2626; }
        .btn-success { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .input {
            width: 100%;
            padding: 15px;
            background: #1e293b;
            border: 2px solid #475569;
            border-radius: 10px;
            color: white;
            font-size: 1.3rem;
            font-family: inherit;
            font-weight: bold;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 20px;
        }
        .vehicle-item {
            background: #0f172a;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #334155;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        .vehicle-thumb {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #475569;
        }
        .message {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }
        .message.success { background: #16a34a; }
        .message.error { background: #dc2626; }
        .message.info { background: #0891b2; }
        .hidden { display: none !important; }
        .loader {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #334155;
            border-top: 5px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-value { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .btn-group .btn { flex: 1; min-width: 200px; }
        .flat-item {
            background: #0f172a;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #334155;
            margin-bottom: 15px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #334155;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
        }
        canvas { display: none; }
        .setup-box {
            background: #0f172a;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #f59e0b;
            margin-bottom: 20px;
        }
        .setup-box h3 {
            color: #f59e0b;
            margin-bottom: 15px;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 2px solid #475569;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VEHICLE MANAGER</h1>
            <p style="margin: 0 0 10px 0; opacity: 0.8; font-size: 1.1rem;">Society Vehicle Tracking & Billing System</p>
            <div class="sync-status">
                <span class="sync-dot"></span>
                <span id="syncStatus">Cloud Sync Active</span>
            </div>
        </div>

        <!-- Firebase Setup Section -->
        <div id="setupSection" class="content">
            <div class="setup-box">
                <h3>‚öôÔ∏è Firebase Configuration Required</h3>
                <p style="margin-bottom: 20px; opacity: 0.8;">Please enter your Firebase configuration to enable cloud sync:</p>
                
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Firebase API Key:</label>
                <input type="text" id="apiKey" class="config-input" placeholder="AIzaSy...">
                
                <label style="display: block; margin-bottom: 8px; margin-top: 15px; opacity: 0.8;">Project ID:</label>
                <input type="text" id="projectId" class="config-input" placeholder="your-project-id">
                
                <label style="display: block; margin-bottom: 8px; margin-top: 15px; opacity: 0.8;">Database URL:</label>
                <input type="text" id="databaseURL" class="config-input" placeholder="https://your-project.firebaseio.com">
                
                <button class="btn btn-success" style="width: 100%; margin-top: 20px;" onclick="app.saveFirebaseConfig()">
                    üíæ Save Configuration & Start
                </button>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,212,255,0.1); border-radius: 10px; border: 1px solid #00d4ff;">
                    <p style="font-size: 0.9rem; opacity: 0.9;">
                        <strong>Don't have Firebase setup?</strong><br>
                        <a href="#" onclick="app.showSetupInstructions(); return false;" style="color: #00d4ff;">Click here for step-by-step setup guide</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="message" class="message hidden"></div>

        <!-- Main App (Hidden until Firebase is configured) -->
        <div id="mainApp" class="hidden">
            <div class="tabs">
                <button class="tab active" onclick="app.switchTab('capture')">üì∑ Capture</button>
                <button class="tab" onclick="app.switchTab('vehicles')">üöó Vehicles</button>
                <button class="tab" onclick="app.switchTab('flats')">üè¢ Flats</button>
                <button class="tab" onclick="app.switchTab('reports')">üìä Reports</button>
            </div>

            <div id="capture-tab" class="content">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <img id="preview" class="preview-img hidden" />
                    <canvas id="canvas"></canvas>
                </div>

                <div class="btn-group" style="justify-content: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="app.capturePhoto()">üì∑ Capture Photo</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÅ Upload Photo</button>
                    <button id="retakeBtn" class="btn btn-danger hidden" onclick="app.resetCapture()">üîÑ Retake</button>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="app.handleFileUpload(event)">

                <div id="processingDiv" class="hidden" style="text-align: center; padding: 20px;">
                    <div class="loader"></div>
                    <p style="margin-top: 15px; font-size: 1.1rem;">Processing image...</p>
                </div>

                <div id="vehicleForm" class="hidden" style="background: #0f172a; padding: 25px; border-radius: 15px; border: 2px solid #334155; margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-size: 1.1rem; font-weight: bold;">Detected Vehicle Number:</label>
                    <input type="text" id="vehicleNumber" class="input" placeholder="ENTER VEHICLE NUMBER" />

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="app.showFlatModal()">Assign to Flat</button>
                        <button class="btn btn-warning" onclick="app.addVehicle(null)">Mark as Unnamed</button>
                    </div>
                </div>
            </div>

            <div id="vehicles-tab" class="content hidden">
                <h2 style="margin-bottom: 20px;">Registered Vehicles (<span id="vehicleCount">0</span>)</h2>
                <div id="vehicleList"></div>
            </div>

            <div id="flats-tab" class="content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">Flats (<span id="flatCount">0</span>)</h2>
                    <button class="btn btn-success" onclick="app.addFlat()">‚ûï Add Flat</button>
                </div>

                <div style="background: #0f172a; padding: 25px; border-radius: 15px; border: 2px solid #334155; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Parking Charges</h3>
                        <button id="editChargesBtn" class="btn btn-secondary" onclick="app.toggleEditCharges()">‚úèÔ∏è Edit</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Owner - 1st Vehicle</label>
                            <input type="number" id="ownerFirst" class="input" disabled style="font-size: 1.1rem; padding: 12px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Owner - 2nd+ Vehicle</label>
                            <input type="number" id="ownerSubsequent" class="input" disabled style="font-size: 1.1rem; padding: 12px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Tenant - 1st Vehicle</label>
                            <input type="number" id="tenantFirst" class="input" disabled style="font-size: 1.1rem; padding: 12px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Tenant - 2nd+ Vehicle</label>
                            <input type="number" id="tenantSubsequent" class="input" disabled style="font-size: 1.1rem; padding: 12px;">
                        </div>
                    </div>
                </div>

                <div id="flatList"></div>
            </div>

            <div id="reports-tab" class="content hidden">
                <h2 style="margin-bottom: 25px;">Reports & Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #00d4ff 0%, #0891b2 100%);">
                        <div class="stat-value" id="statTotalVehicles">0</div>
                        <div>Total Vehicles</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #7e5fff 0%, #6d28d9 100%);">
                        <div class="stat-value" id="statTotalFlats">0</div>
                        <div>Total Flats</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);">
                        <div class="stat-value" id="statTotalCharges">‚Çπ0</div>
                        <div>Total Charges</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="stat-value" id="statUnnamed">0</div>
                        <div>Unnamed Vehicles</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="app.exportCSV()">üì• Download CSV Report</button>
                    <button class="btn" style="background: linear-gradient(135deg, #7e5fff 0%, #6d28d9 100%);" onclick="app.exportJSON()">üì• Export All Data</button>
                </div>

                <div id="unnamedSection" style="margin-top: 30px;"></div>
            </div>
        </div>

        <div id="flatModal" class="modal hidden">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">Select Flat</h3>
                <div id="flatModalList" style="margin-bottom: 20px;"></div>
                <button class="btn btn-danger" style="width: 100%;" onclick="app.closeFlatModal()">Cancel</button>
            </div>
        </div>

        <!-- Setup Instructions Modal -->
        <div id="setupModal" class="modal hidden">
            <div class="modal-content" style="max-width: 700px;">
                <h2 style="margin-bottom: 20px;">Firebase Setup Guide</h2>
                <div style="text-align: left; line-height: 1.8;">
                    <h3 style="color: #00d4ff; margin: 20px 0 10px 0;">Step 1: Create Firebase Project</h3>
                    <ol style="padding-left: 20px;">
                        <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color: #00d4ff;">https://console.firebase.google.com</a></li>
                        <li>Click "Add Project"</li>
                        <li>Name it "vehicle-manager"</li>
                        <li>Disable Google Analytics (not needed)</li>
                        <li>Click "Create Project"</li>
                    </ol>

                    <h3 style="color: #00d4ff; margin: 20px 0 10px 0;">Step 2: Set Up Realtime Database</h3>
                    <ol style="padding-left: 20px;">
                        <li>In left menu, click "Build" ‚Üí "Realtime Database"</li>
                        <li>Click "Create Database"</li>
                        <li>Choose location closest to you</li>
                        <li>Select "Start in <strong>test mode</strong>"</li>
                        <li>Click "Enable"</li>
                    </ol>

                    <h3 style="color: #00d4ff; margin: 20px 0 10px 0;">Step 3: Get Your Configuration</h3>
                    <ol style="padding-left: 20px;">
                        <li>Click the gear icon ‚öôÔ∏è ‚Üí "Project settings"</li>
                        <li>Scroll down to "Your apps"</li>
                        <li>Click the web icon "&lt;/&gt;"</li>
                        <li>Name it "vehicle-app" ‚Üí Click "Register"</li>
                        <li>Copy the configuration values you see</li>
                    </ol>

                    <h3 style="color: #00d4ff; margin: 20px 0 10px 0;">Step 4: Enter Configuration</h3>
                    <p>Copy these values from Firebase and paste them in the form:</p>
                    <ul style="padding-left: 20px;">
                        <li><strong>API Key:</strong> Starts with "AIzaSy..."</li>
                        <li><strong>Project ID:</strong> Your project name</li>
                        <li><strong>Database URL:</strong> Ends with ".firebaseio.com"</li>
                    </ul>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(22,163,74,0.2); border-radius: 10px; border: 1px solid #16a34a;">
                        <p><strong>‚úÖ That's it!</strong> Your app will sync across all devices in real-time.</p>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="app.closeSetupModal()">Got It!</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        window.app = {
            vehicles: [],
            flats: [],
            charges: { ownerFirst: 500, ownerSubsequent: 300, tenantFirst: 600, tenantSubsequent: 400 },
            currentPhoto: null,
            stream: null,
            editingCharges: false,
            db: null,
            firebaseApp: null,

            init() {
                const config = this.loadFirebaseConfig();
                if (config) {
                    this.initializeFirebase(config);
                } else {
                    document.getElementById('setupSection').classList.remove('hidden');
                }
            },

            loadFirebaseConfig() {
                const configStr = localStorage.getItem('firebaseConfig');
                return configStr ? JSON.parse(configStr) : null;
            },

            saveFirebaseConfig() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const projectId = document.getElementById('projectId').value.trim();
                const databaseURL = document.getElementById('databaseURL').value.trim();

                if (!apiKey || !projectId || !databaseURL) {
                    this.showMessage('Please fill in all fields', 'error');
                    return;
                }

                const config = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    databaseURL: databaseURL,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`,
                    messagingSenderId: "123456789",
                    appId: "1:123456789:web:abcdef123456"
                };

                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                this.initializeFirebase(config);
            },

            initializeFirebase(config) {
                try {
                    this.firebaseApp = initializeApp(config);
                    this.db = getDatabase(this.firebaseApp);
                    
                    document.getElementById('setupSection').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    this.loadDataFromFirebase();
                    this.startCamera();
                    this.showMessage('‚úÖ Connected to cloud database', 'success');
                } catch (error) {
                    console.error('Firebase error:', error);
                    this.showMessage('‚ùå Configuration error. Please check your Firebase settings.', 'error');
                    localStorage.removeItem('firebaseConfig');
                    document.getElementById('setupSection').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                }
            },

            loadDataFromFirebase() {
                // Load vehicles
                const vehiclesRef = ref(this.db, 'vehicles');
                onValue(vehiclesRef, (snapshot) => {
                    const data = snapshot.val();
                    this.vehicles = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
                    this.render();
                });

                // Load flats
                const flatsRef = ref(this.db, 'flats');
                onValue(flatsRef, (snapshot) => {
                    const data = snapshot.val();
                    this.flats = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
                    this.updateChargeInputs();
                    this.render();
                });

                // Load charges
                const chargesRef = ref(this.db, 'charges');
                onValue(chargesRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.charges = data;
                        this.updateChargeInputs();
                    }
                });
            },

            updateChargeInputs() {
                document.getElementById('ownerFirst').value = this.charges.ownerFirst;
                document.getElementById('ownerSubsequent').value = this.charges.ownerSubsequent;
                document.getElementById('tenantFirst').value = this.charges.tenantFirst;
                document.getElementById('tenantSubsequent').value = this.charges.tenantSubsequent;
            },

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    document.getElementById('video').srcObject = stream;
                    this.stream = stream;
                } catch (error) {
                    this.showMessage('Camera access denied. Please allow camera permissions.', 'error');
                }
            },

            capturePhoto() {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const preview = document.getElementById('preview');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                this.currentPhoto = canvas.toDataURL('image/jpeg');
                preview.src = this.currentPhoto;
                preview.classList.remove('hidden');
                video.classList.add('hidden');
                document.getElementById('retakeBtn').classList.remove('hidden');
                
                this.processImage(this.currentPhoto);
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentPhoto = e.target.result;
                        const preview = document.getElementById('preview');
                        preview.src = this.currentPhoto;
                        preview.classList.remove('hidden');
                        document.getElementById('video').classList.add('hidden');
                        document.getElementById('retakeBtn').classList.remove('hidden');
                        this.processImage(this.currentPhoto);
                    };
                    reader.readAsDataURL(file);
                }
            },

            async processImage(imageData) {
                document.getElementById('processingDiv').classList.remove('hidden');
                
                try {
                    const result = await Tesseract.recognize(imageData, 'eng');
                    const text = result.data.text.toUpperCase();
                    const platePattern = /[A-Z]{2}[0-9]{1,2}[A-Z]{0,3}[0-9]{4}/g;
                    const matches = text.match(platePattern);
                    
                    if (matches && matches.length > 0) {
                        const detectedNumber = matches[0].replace(/\s+/g, '');
                        document.getElementById('vehicleNumber').value = detectedNumber;
                        this.checkVehicleExists(detectedNumber);
                    } else {
                        this.showMessage('Could not detect vehicle number. Please enter manually.', 'info');
                        document.getElementById('vehicleNumber').value = '';
                    }
                    
                    document.getElementById('vehicleForm').classList.remove('hidden');
                } catch (error) {
                    this.showMessage('Error processing image. Please try again.', 'error');
                } finally {
                    document.getElementById('processingDiv').classList.add('hidden');
                }
            },

            checkVehicleExists(vehicleNumber) {
                const exists = this.vehicles.find(v => v.number === vehicleNumber);
                if (exists) {
                    this.showMessage(`Vehicle ${vehicleNumber} already registered to ${exists.flatNumber || 'Unnamed'}`, 'info');
                }
            },

            resetCapture() {
                this.currentPhoto = null;
                document.getElementById('preview').classList.add('hidden');
                document.getElementById('video').classList.remove('hidden');
                document.getElementById('retakeBtn').classList.add('hidden');
                document.getElementById('vehicleForm').classList.add('hidden');
                document.getElementById('vehicleNumber').value = '';
            },

            calculateCharge(flatNumber) {
                const flat = this.flats.find(f => f.number === flatNumber);
                if (!flat) return 0;

                const vehicleCount = this.vehicles.filter(v => v.flatNumber === flatNumber).length + 1;
                const isOwner = flat.type === 'owner';

                if (vehicleCount === 1) {
                    return isOwner ? this.charges.ownerFirst : this.charges.tenantFirst;
                } else {
                    return isOwner ? this.charges.ownerSubsequent : this.charges.tenantSubsequent;
                }
            },

            async addVehicle(flatNumber) {
                const vehicleNumber = document.getElementById('vehicleNumber').value.trim().toUpperCase();
                
                if (!vehicleNumber) {
                    this.showMessage('Please enter vehicle number', 'error');
                    return;
                }

                const exists = this.vehicles.find(v => v.number === vehicleNumber);
                if (exists) {
                    this.showMessage('Vehicle already exists', 'error');
                    return;
                }

                const charge = flatNumber ? this.calculateCharge(flatNumber) : 0;
                
                const newVehicle = {
                    id: Date.now(),
                    number: vehicleNumber,
                    flatNumber: flatNumber || null,
                    photo: this.currentPhoto,
                    timestamp: new Date().toISOString(),
                    charge: charge,
                    status: flatNumber ? 'registered' : 'unnamed'
                };

                const vehiclesRef = ref(this.db, 'vehicles');
                const newVehicleRef = push(vehiclesRef);
                await set(newVehicleRef, newVehicle);

                this.showMessage(`Vehicle ${vehicleNumber} ${flatNumber ? 'registered to Flat ' + flatNumber : 'marked as Unnamed'}`, 'success');
                this.resetCapture();
            },

            showFlatModal() {
                const vehicleNumber = document.getElementById('vehicleNumber').value.trim();
                if (!vehicleNumber) {
                    this.showMessage('Please enter vehicle number first', 'error');
                    return;
                }

                if (this.flats.length === 0) {
                    this.showMessage('No flats available. Please add flats first.', 'error');
                    this.switchTab('flats');
                    return;
                }

                const modalList = document.getElementById('flatModalList');
                modalList.innerHTML = '';

                this.flats.forEach(flat => {
                    const flatVehicles = this.vehicles.filter(v => v.flatNumber === flat.number);
                    const nextCharge = this.calculateCharge(flat.number);
                    
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary';
                    btn.style.width = '100%';
                    btn.style.marginBottom = '10px';
                    btn.style.textAlign = 'left';
                    btn.innerHTML = `
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">Flat ${flat.number}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Type: ${flat.type.toUpperCase()} | Vehicles: ${flatVehicles.length} | Next Charge: ‚Çπ${nextCharge}</div>
                    `;
                    btn.onclick = () => {
                        this.addVehicle(flat.number);
                        this.closeFlatModal();
                    };
                    modalList.appendChild(btn);
                });

                document.getElementById('flatModal').classList.remove('hidden');
            },

            closeFlatModal() {
                document.getElementById('flatModal').classList.add('hidden');
            },

            async addFlat() {
                const flatNumber = prompt('Enter flat number:');
                const flatType = prompt('Enter type (owner/tenant):')?.toLowerCase();
                
                if (flatNumber && (flatType === 'owner' || flatType === 'tenant')) {
                    const exists = this.flats.find(f => f.number === flatNumber);
                    if (exists) {
                        this.showMessage('Flat already exists', 'error');
                        return;
                    }
                    
                    const flatsRef = ref(this.db, 'flats');
                    const newFlatRef = push(flatsRef);
                    await set(newFlatRef, { number: flatNumber, type: flatType });

                    this.showMessage('Flat added successfully', 'success');
                } else {
                    this.showMessage('Invalid input. Type must be owner or tenant.', 'error');
                }
            },

            async deleteFlat(flatNumber, firebaseKey) {
                const hasVehicles = this.vehicles.some(v => v.flatNumber === flatNumber);
                if (hasVehicles) {
                    this.showMessage('Cannot delete flat with registered vehicles', 'error');
                    return;
                }
                
                if (confirm(`Delete Flat ${flatNumber}?`)) {
                    const flatRef = ref(this.db, `flats/${firebaseKey}`);
                    await remove(flatRef);
                    this.showMessage('Flat deleted', 'success');
                }
            },

            async deleteVehicle(id, firebaseKey) {
                if (confirm('Delete this vehicle?')) {
                    const vehicleRef = ref(this.db, `vehicles/${firebaseKey}`);
                    await remove(vehicleRef);
                    this.showMessage('Vehicle deleted', 'success');
                }
            },

            toggleEditCharges() {
                this.editingCharges = !this.editingCharges;
                const inputs = ['ownerFirst', 'ownerSubsequent', 'tenantFirst', 'tenantSubsequent'];
                inputs.forEach(id => {
                    document.getElementById(id).disabled = !this.editingCharges;
                });

                if (this.editingCharges) {
                    document.getElementById('editChargesBtn').textContent = 'üíæ Save';
                    document.getElementById('editChargesBtn').className = 'btn btn-success';
                } else {
                    this.charges.ownerFirst = parseInt(document.getElementById('ownerFirst').value);
                    this.charges.ownerSubsequent = parseInt(document.getElementById('ownerSubsequent').value);
                    this.charges.tenantFirst = parseInt(document.getElementById('tenantFirst').value);
                    this.charges.tenantSubsequent = parseInt(document.getElementById('tenantSubsequent').value);
                    
                    const chargesRef = ref(this.db, 'charges');
                    set(chargesRef, this.charges);
                    
                    this.showMessage('Charges updated successfully', 'success');
                    document.getElementById('editChargesBtn').textContent = '‚úèÔ∏è Edit';
                    document.getElementById('editChargesBtn').className = 'btn btn-secondary';
                }
            },

            exportCSV() {
                const report = this.vehicles.map(v => {
                    const flat = this.flats.find(f => f.number === v.flatNumber);
                    return {
                        'Vehicle Number': v.number,
                        'Flat Number': v.flatNumber || 'UNNAMED',
                        'Flat Type': flat?.type || 'N/A',
                        'Charge': v.charge,
                        'Status': v.status,
                        'Registered On': new Date(v.timestamp).toLocaleString()
                    };
                });

                const csv = [
                    Object.keys(report[0] || {}).join(','),
                    ...report.map(row => Object.values(row).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vehicle-report-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                this.showMessage('CSV report downloaded', 'success');
            },

            exportJSON() {
                const data = {
                    vehicles: this.vehicles,
                    flats: this.flats,
                    charges: this.charges,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vehicle-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                this.showMessage('Data exported successfully', 'success');
            },

            switchTab(tabName) {
                ['capture', 'vehicles', 'flats', 'reports'].forEach(tab => {
                    document.getElementById(`${tab}-tab`).classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');

                this.render();
            },

            showMessage(text, type) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.className = `message ${type}`;
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 4000);
            },

            showSetupInstructions() {
                document.getElementById('setupModal').classList.remove('hidden');
            },

            closeSetupModal() {
                document.getElementById('setupModal').classList.add('hidden');
            },

            render() {
                document.getElementById('vehicleCount').textContent = this.vehicles.length;
                document.getElementById('flatCount').textContent = this.flats.length;

                const vehicleList = document.getElementById('vehicleList');
                if (this.vehicles.length === 0) {
                    vehicleList.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 40px;">No vehicles registered yet</p>';
                } else {
                    vehicleList.innerHTML = this.vehicles.map(v => `
                        <div class="vehicle-item">
                            <img src="${v.photo}" class="vehicle-thumb" alt="${v.number}">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 8px; letter-spacing: 2px; color: #00d4ff;">${v.number}</div>
                                <div style="font-size: 0.95rem; opacity: 0.8; margin-bottom: 5px;">Flat: <strong>${v.flatNumber || 'UNNAMED'}</strong></div>
                                <div style="font-size: 0.95rem; opacity: 0.8; margin-bottom: 5px;">Charge: <strong>‚Çπ${v.charge}</strong></div>
                                <div style="font-size: 0.85rem; opacity: 0.6;">${new Date(v.timestamp).toLocaleString()}</div>
                            </div>
                            <button class="btn btn-danger" style="padding: 10px;" onclick="app.deleteVehicle(${v.id}, '${v.firebaseKey}')">üóëÔ∏è</button>
                        </div>
                    `).join('');
                }

                const flatList = document.getElementById('flatList');
                if (this.flats.length === 0) {
                    flatList.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 40px;">No flats added yet</p>';
                } else {
                    flatList.innerHTML = this.flats.map(flat => {
                        const flatVehicles = this.vehicles.filter(v => v.flatNumber === flat.number);
                        const totalCharge = flatVehicles.reduce((sum, v) => sum + v.charge, 0);
                        return `
                            <div class="flat-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 8px;">Flat ${flat.number}</div>
                                        <div style="font-size: 0.95rem; opacity: 0.8; margin-bottom: 5px;">Type: <strong style="color: ${flat.type === 'owner' ? '#00d4ff' : '#f59e0b'}; text-transform: uppercase;">${flat.type}</strong></div>
                                        <div style="font-size: 0.95rem; opacity: 0.8;">Vehicles: <strong>${flatVehicles.length}</strong> | Total Charge: <strong>‚Çπ${totalCharge}</strong></div>
                                    </div>
                                    <button class="btn btn-danger" style="padding: 10px;" onclick="app.deleteFlat('${flat.number}', '${flat.firebaseKey}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('statTotalVehicles').textContent = this.vehicles.length;
                document.getElementById('statTotalFlats').textContent = this.flats.length;
                document.getElementById('statTotalCharges').textContent = '‚Çπ' + this.vehicles.reduce((sum, v) => sum + v.charge, 0);
                document.getElementById('statUnnamed').textContent = this.vehicles.filter(v => !v.flatNumber).length;

                const unnamedVehicles = this.vehicles.filter(v => !v.flatNumber);
                const unnamedSection = document.getElementById('unnamedSection');
                if (unnamedVehicles.length > 0) {
                    unnamedSection.innerHTML = `
                        <h3 style="margin-bottom: 15px; color: #f59e0b;">‚ö†Ô∏è Unnamed Vehicles Requiring Action</h3>
                        ${unnamedVehicles.map(v => `
                            <div class="vehicle-item" style="border-color: #f59e0b;">
                                <img src="${v.photo}" class="vehicle-thumb" style="border-color: #f59e0b;" alt="${v.number}">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 8px; letter-spacing: 2px; color: #f59e0b;">${v.number}</div>
                                    <div style="font-size: 0.95rem; opacity: 0.8; margin-bottom: 5px;">Status: <strong>UNNAMED - Requires Assignment</strong></div>
                                    <div style="font-size: 0.85rem; opacity: 0.6;">Timestamp: ${new Date(v.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    unnamedSection.innerHTML = '';
                }
            }
        };

        window.addEventListener('load', () => {
            window.app.init();
        });
    </script>
</body>
</html>
